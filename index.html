<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I'm OK - Daily Safety Check</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>

    <div class="card">
        <select id="langSelector" class="lang-select">
            <option value="en">ðŸ‡ºðŸ‡¸ EN</option>
            <option value="ja">ðŸ‡¯ðŸ‡µ JA</option>
            <option value="vi">ðŸ‡»ðŸ‡³ VI</option>
            <option value="es">ðŸ‡ªðŸ‡¸ ES</option>
        </select>
        <div class="icon-pulse">â™¥</div>
        <h1 data-i18n="title">I'm OK</h1>
        <p class="subtitle" data-i18n="subtitle">Set up your daily safety monitor.</p>

        <form id="setupForm">
            <div class="mb-3 text-start">
                <label class="form-label small text-muted" data-i18n="label_email">YOUR EMAIL</label>
                <input type="email" id="owner" class="form-control" placeholder="you@email.com" required>
            </div>
            <div class="mb-3 text-start">
                <label class="form-label small text-muted" data-i18n="label_contact">CONTACT EMAIL</label>
                <input type="email" id="subscriber" class="form-control" placeholder="trusted_friend@email.com"
                    required>
            </div>
            <div class="row">
                <div class="col-6 mb-3 text-start">
                    <label class="form-label small text-muted" data-i18n="label_timeout">TIMEOUT</label>
                    <div class="input-group">
                        <input type="number" id="timeoutValue" class="form-control" value="24" min="1" required
                            style="flex: 1;">
                        <select id="timeoutUnit" class="form-control"
                            style="width: auto; flex: 0 0 auto; min-width: 80px;">
                            <option value="1" data-i18n="unit_hrs">Hrs</option>
                            <option value="24" data-i18n="unit_days">Days</option>
                            <option value="168" data-i18n="unit_wks">Wks</option>
                            <option value="720" data-i18n="unit_mos">Mos</option>
                        </select>
                    </div>
                </div>
                <div class="col-6 mb-3 text-start">
                    <label class="form-label small text-muted" data-i18n="label_secret">SECRET CODE</label>
                    <input type="password" id="secret" class="form-control" required>
                </div>
            </div>

            <p class="small text-muted mb-2" data-i18n="text_tos" style="font-size: 0.7rem;">
                This service is provided 'as-is' without warranty. Do not rely on this as your sole safety method.
            </p>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="tosCheck" required>
                <label class="form-check-label" for="tosCheck" data-i18n="label_agree">
                    I agree to the Terms of Service
                </label>
            </div>

            <button type="submit" id="btnSubmit" class="btn btn-brand mt-3" data-i18n="btn_start" disabled>Start
                Monitoring</button>
        </form>

        <div id="message" class="mt-4 small"></div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // Replace this with your actual Cloud Run URL
        // const API_URL = "http://localhost:8080";
        const API_URL = "https://im-ok-253481026994.asia-northeast1.run.app";

        // --- I18N CONFIGURATION ---
        const translations = {
            en: {
                title: "I'm OK",
                subtitle: "Set up your daily safety monitor.",
                label_email: "YOUR EMAIL",
                label_contact: "CONTACT EMAIL",
                label_timeout: "TIMEOUT",
                label_secret: "SECRET CODE",
                btn_start: "Start Monitoring",
                btn_setting: "Setting up...",
                msg_success: "âœ” Setup Complete!",
                msg_server_err: "âœ– Server unreachable.",
                unit_hrs: "Hrs",
                unit_days: "Days",
                unit_wks: "Wks",
                unit_mos: "Mos",
                text_tos: "This service is provided 'as-is' without warranty. Do not rely on this as your sole safety method.",
                label_agree: "I agree to the Terms of Service"
            },
            ja: {
                title: "I'm OK",
                subtitle: "æ¯Žæ—¥ã®å®‰å¦ç¢ºèªã‚’è¨­å®šã—ã¾ã™ã€‚",
                label_email: "ã‚ãªãŸã®ãƒ¡ãƒ¼ãƒ«",
                label_contact: "é€£çµ¡å…ˆãƒ¡ãƒ¼ãƒ«",
                label_timeout: "ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ",
                label_secret: "æš—è¨¼ã‚³ãƒ¼ãƒ‰",
                btn_start: "ç›£è¦–ã‚’é–‹å§‹",
                btn_setting: "è¨­å®šä¸­...",
                msg_success: "âœ” è¨­å®šå®Œäº†ï¼",
                msg_server_err: "âœ– ã‚µãƒ¼ãƒãƒ¼ã«æŽ¥ç¶šã§ãã¾ã›ã‚“ã€‚",
                unit_hrs: "æ™‚é–“",
                unit_days: "æ—¥",
                unit_wks: "é€±",
                unit_mos: "ãƒ¶æœˆ",
                text_tos: "æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€Œç¾çŠ¶æœ‰å§¿ã€ã§æä¾›ã•ã‚Œã€ã„ã‹ãªã‚‹ä¿è¨¼ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚å”¯ä¸€ã®å®‰å…¨æ‰‹æ®µã¨ã—ã¦ä¾å­˜ã—ãªã„ã§ãã ã•ã„ã€‚",
                label_agree: "åˆ©ç”¨è¦ç´„ã«åŒæ„ã—ã¾ã™"
            },
            vi: {
                title: "I'm OK",
                subtitle: "Thiáº¿t láº­p giÃ¡m sÃ¡t an toÃ n hÃ ng ngÃ y.",
                label_email: "EMAIL Cá»¦A Báº N",
                label_contact: "EMAIL LIÃŠN Há»†",
                label_timeout: "THá»œI GIAN CHá»œ",
                label_secret: "MÃƒ BÃ Máº¬T",
                btn_start: "Báº¯t Ä‘áº§u giÃ¡m sÃ¡t",
                btn_setting: "Äang thiáº¿t láº­p...",
                msg_success: "âœ” Thiáº¿t láº­p hoÃ n táº¥t!",
                msg_server_err: "âœ– KhÃ´ng thá»ƒ káº¿t ná»‘i mÃ¡y chá»§.",
                unit_hrs: "Giá»",
                unit_days: "NgÃ y",
                unit_wks: "Tuáº§n",
                unit_mos: "ThÃ¡ng",
                text_tos: "Dá»‹ch vá»¥ nÃ y Ä‘Æ°á»£c cung cáº¥p 'nguyÃªn tráº¡ng' mÃ  khÃ´ng cÃ³ báº£o hÃ nh. Äá»«ng dá»±a vÃ o Ä‘Ã¢y nhÆ° lÃ  phÆ°Æ¡ng phÃ¡p an toÃ n duy nháº¥t cá»§a báº¡n.",
                label_agree: "TÃ´i Ä‘á»“ng Ã½ vá»›i Äiá»u khoáº£n dá»‹ch vá»¥"
            },
            es: {
                title: "I'm OK",
                subtitle: "Configura tu monitor de seguridad diario.",
                label_email: "TU CORREO",
                label_contact: "CORREO DE CONTACTO",
                label_timeout: "TIEMPO DE ESPERA",
                label_secret: "CÃ“DIGO SECRETO",
                btn_start: "Iniciar Monitoreo",
                btn_setting: "Configurando...",
                msg_success: "âœ” Â¡ConfiguraciÃ³n Completa!",
                msg_server_err: "âœ– Servidor inalcanzable.",
                unit_hrs: "Hrs",
                unit_days: "DÃ­as",
                unit_wks: "Sem",
                unit_mos: "Mes",
                text_tos: "Este servicio se proporciona 'tal cual' sin garantÃ­a. No confÃ­e en esto como su Ãºnico mÃ©todo de seguridad.",
                label_agree: "Acepto los TÃ©rminos de Servicio"
            }
        };

        const langSelector = document.getElementById('langSelector');
        let currentLang = 'en';

        function updateLanguage(lang) {
            currentLang = lang;
            const t = translations[lang];

            // Update Text Elements
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) {
                    el.innerText = t[key];
                }
            });
        }

        langSelector.addEventListener('change', (e) => {
            updateLanguage(e.target.value);
        });

        // Initialize
        updateLanguage('en');

        // ToS Checkbox Logic
        const tosCheck = document.getElementById('tosCheck');
        const btnSubmit = document.getElementById('btnSubmit');

        tosCheck.addEventListener('change', (e) => {
            btnSubmit.disabled = !e.target.checked;
        });

        document.getElementById('setupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const msg = document.getElementById('message');
            // const btn = e.target.querySelector('button'); // Don't re-select since we have ID
            const t = translations[currentLang];

            msg.innerText = "";
            btnSubmit.disabled = true;
            btnSubmit.innerText = t.btn_setting;

            const payload = {
                owner: document.getElementById('owner').value,
                subscriber: document.getElementById('subscriber').value,
                hours: parseInt(document.getElementById('timeoutValue').value) * parseInt(document.getElementById('timeoutUnit').value),
                secret: document.getElementById('secret').value,
                language: currentLang
            };

            try {
                const response = await fetch(`${API_URL}/api/setup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (response.ok) {
                    msg.innerHTML = `<span class="text-success fw-bold">${t.msg_success}</span>`;
                    e.target.reset();
                    // Reset to default values if needed, or keep last state
                    document.getElementById('timeoutValue').value = "24";
                    document.getElementById('timeoutUnit').value = "1";
                } else {
                    msg.innerHTML = `<span class="text-danger">âœ– ${data.error || 'Failed'}</span>`;
                }
            } catch (err) {
                console.error(err);
                msg.innerHTML = `<span class="text-danger">${t.msg_server_err}</span>`;
            }

            btnSubmit.disabled = false; // Re-enable because we know checked is true (required passed)
            // But wait, if we reset form, check is gone?
            // If success, we reset form, so check is unchecked.
            if (response.ok) {
                btnSubmit.disabled = true; // Keep disabled until checked again
            }

            btnSubmit.innerText = t.btn_start;
        });
    </script>
</body>

</html>